// JenScript -  JavaScript HTML5/SVG Library
// version : 1.3.1
// Author : Sebastien Janaud 
// Web Site : http://jenscript.io
// Twitter  : http://twitter.com/JenSoftAPI
// Copyright (C) 2008 - 2017 JenScript, product by JenSoftAPI company, France.
// build: 2017-06-01
// All Rights reserved

!function(){JenScript.AffineTranformPlugin=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.AffineTranformPlugin,JenScript.Plugin),JenScript.Model.addMethods(JenScript.AffineTranformPlugin,{_init:function(a){a=a||{},a.priority=1e3,this.slaves=void 0!==a.slaves?a.slaves:[],a.name="AffineTranformPlugin",JenScript.Plugin.call(this,a),this.startPoint,this.currentPoint,this.translate=!1,this.factor=void 0!==a.factor?a.factor:1.1},onPress:function(a,b,c,d){a.preventDefault&&a.preventDefault(),"Device"===b&&(this.translate=!0,this.startPoint=new JenScript.Point2D(c,d))},onRelease:function(){this.translate=!1,this.firePluginEvent("transform-release")},onMove:function(a,b,c,d){"Device"===b&&this.translate&&(this.affineTranslate(a,b,c,d),this.startPoint=this.currentPoint)},onWheel:function(a){a.preventDefault();var b=this,c=function(a){setTimeout(function(){b.affineScale(b.factor)},20*a)},d=function(a){setTimeout(function(){b.affineScale(1/b.factor)},20*a)},e=function(a){if(0>a)for(var b=-a,e=0;b>e;e++)c(e);else for(var b=a,e=0;b>e;e++)d(e)};a.deltaY&&e(a.deltaY)},u2p:function(a,b){var c=this.getProjection().userToPixel(b);return new JenScript.Point2D(c.x*a.sx+a.tx,c.y*a.sy+a.ty)},p2u:function(a,b){return this.getProjection().pixelToUser(new JenScript.Point2D((b.x-a.tx)/a.sx,(b.y-a.ty)/a.sy))},minX:function(a){return this.p2u(a,{x:0,y:0}).x},maxX:function(a){return this.p2u(a,{x:this.getDevice().getWidth(),y:0}).x},minY:function(a){return this.p2u(a,{x:0,y:this.getDevice().getHeight()}).y},maxY:function(a){return this.p2u(a,{x:0,y:0}).y},affineTranslate:function(a,b,c,d){if(this.currentPoint=new JenScript.Point2D(c,d),void 0!==this.startPoint)for(var e=this.currentPoint.x-this.startPoint.x,f=this.currentPoint.y-this.startPoint.y,g=0;g<this.slaves.length;g++){var h=this.slaves[g],i=h.tx+e,j=h.ty+f;h.translate(i,j)}},affineScale:function(a){for(var b=0;b<this.slaves.length;b++){var c=this.slaves[b],d=this.getProjection().getView().getDevice().getWidth(),e=this.getProjection().getView().getDevice().getHeight(),f=this.p2u(c,new JenScript.Point2D(d/2,e/2)),g=c.sx,h=c.sy,i=c.sx*a,j=c.sy*a;c.scale(i,j);var k=this.p2u(c,new JenScript.Point2D(d/2,e/2)),l=this.u2p(c,k),m=this.u2p(c,f);if(void 0!==l&&void 0!==m){var n=c.tx-(m.x-l.x),o=c.ty-(m.y-l.y);isFinite(n)&&isFinite(o)?c.translate(n,o):c.scale(g,h)}}this.firePluginEvent("transform-release")}})}();