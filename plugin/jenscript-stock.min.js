// JenScript -  JavaScript HTML5/SVG Library
// version : 1.3.1
// Author : Sebastien Janaud 
// Web Site : http://jenscript.io
// Twitter  : http://twitter.com/JenSoftAPI
// Copyright (C) 2008 - 2017 JenScript, product by JenSoftAPI company, France.
// build: 2017-05-30
// All Rights reserved

!function(){JenScript.StockPlugin=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockPlugin,JenScript.Plugin),JenScript.Model.addMethods(JenScript.StockPlugin,{_init:function(a){a=a||{},this.stocks=[],this.stockLayers=[],a.priority=1e4,a.name=void 0!==a.name?a.name:"StockPlugin",JenScript.Plugin.call(this,a),this.bearishColor=void 0!==a.bearishColor?a.bearishColor:"red",this.bullishColor=void 0!==a.bullishColor?a.bullishColor:"green"},getBearishColor:function(){return this.bearishColor},setBearishColor:function(a){this.bearishColor=a},getBullishColor:function(){return this.bullishColor},setBullishColor:function(a){this.bullishColor=a},getStocks:function(){return this.stocks},getBoundedStocks:function(){for(var a=[],b=0;b<this.stocks.length;b++){var c=this.stocks[b],d=this.stocks[b-1],e=this.stocks[b+1];c.fixing.getTime()>=this.getProjection().minX&&c.fixing.getTime()<=this.getProjection().maxX&&(void 0!==d&&d.fixing.getTime()<this.getProjection().minX&&(a[a.length]=d),a[a.length]=c,void 0!==e&&e.fixing.getTime()>this.getProjection().maxX&&(a[a.length]=e))}return a},getRangeStocks:function(a,b){for(var c=[],d=0;d<this.stocks.length;d++){var e=this.stocks[d];e.fixing.getTime()>=a.getTime()&&e.fixing.getTime()<=b.getTime()&&(c[c.length]=e)}return c},getLayers:function(){return this.stockLayers},addLayer:function(a){a.plugin=this,this.stockLayers[this.stockLayers.length]=a,this.repaintPlugin()},removeLayer:function(a){for(var b=[],c=0;c<this.stockLayers.length;c++){var d=this.stockLayers[c];d.Id!==a.Id&&(b=d)}this.stockLayers=b,this.repaintPlugin()},removeAllLayer:function(){this.stockLayers=[],this.repaintPlugin()},setStocks:function(a){this.stocks=a,a.sort(function(a,b){var c=a.fixing.getTime(),d=b.fixing.getTime();return c>d?1:-1}),this.repaintPlugin()},addStock:function(a){this.stocks[this.stocks.length]=a,this.setStocks(this.stocks)},paintPlugin:function(a,b){if("Device"===b)for(var c=0;c<this.stockLayers.length;c++){var d=this.stockLayers[c];d.solveLayer(),d.paintLayer(a,b)}},onProjectionRegister:function(){var a=this;this.getProjection().addProjectionListener("boundChanged",function(){a.repaintPlugin()},"Stock plugin listener for projection bound changed")},onPress:function(a,b,c,d){a.preventDefault&&a.preventDefault(),this.isTranslateAuthorized(a,b,c,d)&&this.startTranslate(new JenScript.Point2D(c,d))},onMove:function(a,b,c,d){for(var e=0;e<this.stockLayers.length;e++){var f=this.stockLayers[e];f.onMove(a,b,c,d)}},onPress:function(a,b,c,d){for(var e=0;e<this.stockLayers.length;e++){var f=this.stockLayers[e];f.onPress(a,b,c,d)}},onRelease:function(a,b,c,d){for(var e=0;e<this.stockLayers.length;e++){var f=this.stockLayers[e];f.onRelease(a,b,c,d)}}})}(),function(){JenScript.Stock=function(a){this.init(a)},JenScript.Model.addMethods(JenScript.Stock,{init:function(a){this.fixing=a.fixing,this.fixingDurationMillis=a.fixingDurationMillis,this.open=a.open,this.close=a.close,this.low=a.low,this.high=a.high,this.volume=a.volume,this.lockEnter=!1},isLockEnter:function(){return this.lockEnter},setLockEnter:function(a){this.lockEnter=a},getFixing:function(){return this.fixing},setFixing:function(a){this.fixing=a},getOpen:function(){return this.open},setOpen:function(a){this.open=a},getClose:function(){return this.close},setClose:function(a){this.close=a},getLow:function(){return this.low},setLow:function(a){this.low=a},getHigh:function(){return this.high},setHigh:function(a){this.high=a},getVolume:function(){return this.volume},setVolume:function(a){this.volume=a},getFixingDurationMillis:function(){return this.fixingDurationMillis},setFixingDurationMillis:function(a){this.fixingDurationMillis=a},isBearish:function(){return this.close<this.open},isBullish:function(){return this.close>this.open}})}(),function(){JenScript.StockGeometry=function(a){this.init(a)},JenScript.Model.addMethods(JenScript.StockGeometry,{init:function(a){a=a||{},this.name=a.name,this.layer},setLayer:function(a){this.layer=a},getLayer:function(){return this.layer},solveGeometry:function(){}}),JenScript.StockItemGeometry=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockItemGeometry,JenScript.StockGeometry),JenScript.Model.addMethods(JenScript.StockItemGeometry,{_init:function(a){a=a||{},this.stock,this.deviceLow,this.deviceHigh,this.deviceOpen,this.deviceClose,this.deviceVolume,this.deviceVolumeBase,this.deviceFixing,this.deviceFixingStart,this.deviceFixingEnd,this.deviceFixingDuration,JenScript.StockGeometry.call(this,{name:"StockItemGeometry"})},setStock:function(a){this.stock=a},getStock:function(){return this.stock},solveGeometry:function(){var a=this.stock;this.deviceLow=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),a.getLow())),this.deviceHigh=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),a.getHigh())),this.deviceOpen=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),a.getOpen())),this.deviceClose=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),a.getClose())),this.deviceVolume=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),a.getVolume())),this.deviceVolumeBase=this.getProjection().userToPixel(new JenScript.Point2D(a.getFixing().getTime(),0)),this.deviceFixingStart=this.getProjection().userToPixelX(a.getFixing().getTime()-a.getFixingDurationMillis()/2),this.deviceFixingEnd=this.getProjection().userToPixelX(a.getFixing().getTime()+a.getFixingDurationMillis()/2),this.deviceFixingDuration=Math.abs(this.deviceFixingEnd-this.deviceFixingStart),this.deviceFixing=this.getProjection().userToPixelX(a.getFixing().getTime()),this.solveItemGeometry()},solveItemGeometry:function(){},getProjection:function(){return this.getLayer().plugin.getProjection()}}),JenScript.StockGroupGeometry=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockGroupGeometry,JenScript.StockGeometry),JenScript.Model.addMethods(JenScript.StockGroupGeometry,{_init:function(a){a=a||{},this.stockItemGeometries=[],JenScript.StockGeometry.call(this,{name:"StockGroupGeometry"})},setStockItemGeometries:function(a){this.stockItemGeometries=a},addStockItemGeometries:function(a){this.stockItemGeometries[this.stockItemGeometries.length]=a},getStockItemGeometries:function(){return this.stockItemGeometries},solveGeometry:function(){}})}(),function(){JenScript.StockLayer=function(a){this.init(a)},JenScript.Model.addMethods(JenScript.StockLayer,{init:function(a){a=a||{},this.Id="layer"+JenScript.sequenceId++,this.name=a.name,this.plugin,this.geometries=[],this.stockListeners=[]},clearGeometries:function(){this.geometries=[]},getGeometries:function(){return this.geometries},addGeometry:function(a){this.geometries[this.geometries.length]=a},getHost:function(){return this.plugin},solveLayer:function(){},paintLayer:function(){},onMove:function(){},onPress:function(){},onRelease:function(){},addStockListener:function(a,b,c){if(void 0===c)throw new Error("Symbol listener, listener name should be supplied.");var d={action:a,onEvent:b,name:c};this.stockListeners[this.stockListeners.length]=d},fireStockEvent:function(a,b){for(var c=0;c<this.stockListeners.length;c++){var d=this.stockListeners[c];a===d.action&&d.onEvent(b)}}})}(),function(){JenScript.CandleStickGeometry=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.CandleStickGeometry,JenScript.StockItemGeometry),JenScript.Model.addMethods(JenScript.CandleStickGeometry,{__init:function(a){a=a||{},this.lowHighColor="darkgray",this.deviceLowHighGap,this.deviceOpenCloseGap,this.bound},solveItemGeometry:function(){var a=this.deviceLow,b=this.deviceHigh,c=this.deviceOpen,d=this.deviceClose,e=this.deviceFixingStart,f=this.deviceFixingDuration;this.deviceLowHighGap=(new JenScript.SVGLine).from(a.x,a.y).to(b.x,b.y),this.deviceOpenCloseGap=this.getStock().getOpen()>this.getStock().getClose()?(new JenScript.SVGRect).origin(e,c.y).size(f,Math.abs(c.y-d.y)):(new JenScript.SVGRect).origin(e,d.y).size(f,Math.abs(c.y-d.y))},getBound2D:function(){return this.deviceOpenCloseGap.getBound2D()}}),JenScript.CandleStickLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.CandleStickLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.CandleStickLayer,{_init:function(a){a=a||{},this.lowHighColor=void 0!==a.lowHighColor?a.lowHighColor:"black",JenScript.StockLayer.call(this,{name:"CandleStickLayer"})},setLowHighColor:function(a){this.color=a},getLowHighColor:function(){return this.color},solveLayer:function(){this.geometries=[];for(var a=0;a<this.plugin.getBoundedStocks().length;a++){var b=this.plugin.getBoundedStocks()[a],c=new JenScript.CandleStickGeometry;c.setLayer(this),c.setStock(b),c.solveGeometry(),this.addGeometry(c)}},onRelease:function(a,b,c,d){this.stockCheck("release",a,c,d)},onPress:function(a,b,c,d){this.stockCheck("press",a,c,d)},onMove:function(a,b,c,d){this.stockCheck("move",a,c,d)},stockCheck:function(a,b,c,d){for(var e=this,f=function(b){"press"===a?e.fireStockEvent("press",{stock:b.getStock(),x:c,y:d,device:{x:c,y:d}}):"release"===a?e.fireStockEvent("release",{stock:b.getStock(),x:c,y:d,device:{x:c,y:d}}):e.stockEnterExitTracker(b,c,d)},g=function(b){var e=void 0!==b.getBound2D()&&b.getBound2D().contains(c,d);"move"!==a&&e&&b.getStock().isLockEnter()?f(b):"move"===a&&f(b)},h=0;h<this.geometries.length;h++)g(this.geometries[h])},stockEnterExitTracker:function(a,b,c){void 0!==a.getBound2D()&&(a.getBound2D().contains(b,c)&&!a.getStock().isLockEnter()&&(a.getStock().setLockEnter(!0),this.fireStockEvent("enter",{stock:a.getStock(),x:b,y:c,device:{x:b,y:c}})),a.getBound2D().contains(b,c)&&a.getStock().isLockEnter()?this.fireStockEvent("move",{stock:a.getStock(),x:b,y:c,device:{x:b,y:c}}):!a.getBound2D().contains(b,c)&&a.getStock().isLockEnter()&&(a.getStock().setLockEnter(!1),this.fireStockEvent("exit",{stock:a.getStock(),x:b,y:c,device:{x:b,y:c}})))},paintLayer:function(a,b){if("Device"===b){for(var c=(new JenScript.SVGGroup).Id(this.Id).name("CandleStickLayer"),d=0;d<this.getGeometries().length;d++){var e=this.getGeometries()[d],f=e.deviceLowHighGap.stroke(this.lowHighColor).fillNone();c.child(f.toSVG());var g=e.getStock().isBearish()?this.plugin.getBearishColor():this.plugin.getBullishColor(),h=e.deviceOpenCloseGap.strokeNone().fill(g);c.child(h.toSVG())}a.deleteGraphicsElement(this.Id),a.insertSVG(c.toSVG())}}})}(),function(){JenScript.OhlcGeometry=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.OhlcGeometry,JenScript.StockItemGeometry),JenScript.Model.addMethods(JenScript.OhlcGeometry,{__init:function(a){a=a||{},this.deviceLowHighGap,this.deviceOpenTick,this.deviceCloseTick},solveItemGeometry:function(){var a=this.deviceLow,b=this.deviceHigh,c=this.deviceOpen,d=this.deviceClose,e=this.deviceFixingStart,f=this.deviceFixingDuration;this.deviceLowHighGap=(new JenScript.SVGLine).from(a.x,a.y).to(b.x,b.y),this.deviceLowOpenCloseGap=this.getStock().getOpen()>this.getStock().getClose()?(new JenScript.SVGRect).origin(e,c.y).size(f,Math.abs(c.y-d.y)):(new JenScript.SVGRect).origin(e,d.y).size(f,Math.abs(c.y-d.y)),this.deviceLowHighGap=(new JenScript.SVGLine).from(a.x,a.y).to(b.x,b.y),this.deviceOpenTick=(new JenScript.SVGLine).from(c.x-f/2,c.y).to(c.x,c.y),this.deviceCloseTick=(new JenScript.SVGLine).from(d.x,d.y).to(d.x+f/2,d.y)}}),JenScript.OhlcLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.OhlcLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.OhlcLayer,{_init:function(a){a=a||{},this.markerColor=void 0!==a.markerColor?a.markerColor:"black",this.markerWidth=void 0!==a.markerWidth?a.markerWidth:1.5,JenScript.StockLayer.call(this,{name:"OhlcLayer"})},setMarkerColor:function(a){this.markerColor=a},setMarkerWidth:function(a){this.markerWidth=a},solveLayer:function(){this.geometries=[];for(var a=0;a<this.plugin.getBoundedStocks().length;a++){var b=this.plugin.getBoundedStocks()[a],c=new JenScript.OhlcGeometry;c.setLayer(this),c.setStock(b),c.solveGeometry(),this.addGeometry(c)}},paintLayer:function(a,b){if("Device"===b){for(var c=(new JenScript.SVGGroup).Id(this.Id),d=0;d<this.getGeometries().length;d++){var e=this.getGeometries()[d];c.child(e.deviceLowHighGap.fillNone().stroke(this.markerColor).strokeWidth(this.markerWidth).toSVG()),c.child(e.deviceOpenTick.fillNone().stroke(this.markerColor).strokeWidth(this.markerWidth).toSVG()),c.child(e.deviceCloseTick.fillNone().stroke(this.markerColor).strokeWidth(this.markerWidth).toSVG())}a.deleteGraphicsElement(this.Id),a.insertSVG(c.toSVG())}}})}(),function(){JenScript.VolumeBarGeometry=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.VolumeBarGeometry,JenScript.StockItemGeometry),JenScript.Model.addMethods(JenScript.VolumeBarGeometry,{__init:function(a){a=a||{},this.deviceVolumeGap},solveItemGeometry:function(){var a=this.deviceFixingStart,b=this.deviceFixingDuration,c=this.deviceVolume,d=this.deviceVolumeBase;this.deviceVolumeGap=(new JenScript.SVGRect).origin(a,c.y).size(b,Math.abs(c.y-d.y))}}),JenScript.VolumeBarLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.VolumeBarLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.VolumeBarLayer,{_init:function(a){a=a||{},this.bearishColor=a.bearishColor,this.bullishColor=a.bullishColor,JenScript.StockLayer.call(this,{name:"VolumeBarLayer"})},solveLayer:function(){this.geometries=[];for(var a=0;a<this.plugin.getBoundedStocks().length;a++){var b=this.plugin.getBoundedStocks()[a],c=new JenScript.VolumeBarGeometry;c.setLayer(this),c.setStock(b),c.solveGeometry(),this.addGeometry(c)}},paintLayer:function(a,b){if("Device"===b){for(var c=(new JenScript.SVGGroup).Id(this.Id),d=0;d<this.getGeometries().length;d++){var e=this.getGeometries()[d],f=void 0!==this.bearishColor?this.bearishColor:this.plugin.getBearishColor(),g=void 0!==this.bullishColor?this.bullishColor:this.plugin.getBullishColor(),h=e.getStock().isBearish()?f:g;c.child(e.deviceVolumeGap.fill(h).strokeNone().toSVG())}a.deleteGraphicsElement(this.Id),a.insertSVG(c.toSVG())}}})}(),function(){JenScript.CurveStockGeometry=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.CurveStockGeometry,JenScript.StockGroupGeometry),JenScript.Model.addMethods(JenScript.CurveStockGeometry,{__init:function(a){a=a||{},this.moveCount=void 0!==a.moveCount?a.moveCount:20,JenScript.StockGroupGeometry.call(this,a),this.points=[]},setMoveCount:function(a){this.moveCount=a},getMoveCount:function(){return this.moveCount},getCurvePoints:function(){return this.points},solveGeometry:function(){throw new Error("CurveStockGeometry solve should be supplied")}}),JenScript.StockCurveLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockCurveLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.StockCurveLayer,{_init:function(a){a=a||{},this.curveColor=void 0!==a.curveColor?a.curveColor:"black",this.curveWidth=void 0!==a.curveWidth?a.curveWidth:1,this.moveCount=void 0!==a.moveCount?a.moveCount:20,this.Id="fixing"+JenScript.sequenceId++,a.name=void 0!==a.name?a.name:"StockCurveLayer",JenScript.StockLayer.call(this,a)},setMoveCount:function(a){this.moveCount=a},getMoveCount:function(){return this.moveCount},getGeomInstance:function(){throw new Error("Geometry should be supplied")},solveLayer:function(){this.clearGeometries();var a=this.getGeomInstance();a.setLayer(this),a.solveGeometry(),this.addGeometry(a)},paintLayer:function(a,b){if("Device"===b)for(var c=0;c<this.getGeometries().length;c++){for(var d=this.getGeometries()[c],e=this.plugin.getProjection(),f=d.getCurvePoints(),g=(new JenScript.SVGGroup).Id(this.Id).name(this.name),h=(new JenScript.SVGPath).Id(this.Id+"_path"),i=0;i<f.length;i++){var j=f[i];0==i?h.moveTo(e.userToPixelX(j.x),e.userToPixelY(j.y)):h.lineTo(e.userToPixelX(j.x),e.userToPixelY(j.y))}a.deleteGraphicsElement(this.Id),g.child(h.stroke(this.curveColor).strokeWidth(this.curveWidth).fillNone().toSVG()),a.insertSVG(g.toSVG())}}})}(),function(){JenScript.StockFixingGeometry=function(a){this.___init(a)},JenScript.Model.inheritPrototype(JenScript.StockFixingGeometry,JenScript.CurveStockGeometry),JenScript.Model.addMethods(JenScript.StockFixingGeometry,{___init:function(a){a=a||{},JenScript.CurveStockGeometry.call(this,a)},solveGeometry:function(){for(var a=[],b=this.getLayer().getHost().getStocks(),c=this.getLayer().getHost().getProjection(),d=c.minX,e=c.maxX,f=0;f<b.length;f++){var g=b[f],h=g.getFixing().getTime();h>d&&e>h&&(a[a.length]={x:g.getFixing().getTime(),y:g.getClose()})}this.points=a}}),JenScript.StockFixingLayer=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.StockFixingLayer,JenScript.StockCurveLayer),JenScript.Model.addMethods(JenScript.StockFixingLayer,{__init:function(a){a=a||{},a.name="StockFixingLayer",JenScript.StockCurveLayer.call(this,a)},getGeomInstance:function(){return new JenScript.StockFixingGeometry}})}(),function(){JenScript.StockMovingAverageGeometry=function(a){this.___init(a)},JenScript.Model.inheritPrototype(JenScript.StockMovingAverageGeometry,JenScript.CurveStockGeometry),JenScript.Model.addMethods(JenScript.StockMovingAverageGeometry,{___init:function(a){a=a||{},JenScript.CurveStockGeometry.call(this,a)},solveGeometry:function(){var a=this.getLayer().getHost().getProjection(),b=a.minX,c=a.maxX,d=[],e=this.getLayer().getHost().getStocks();e&&e.sort(function(a,b){return a.getFixing().getTime()>b.getFixing().getTime()?1:-1});for(var f=this.moveCount;f<e.length;f++){for(var g=e[f],h=0,i=0;i<this.moveCount;i++){var j=e[f-i];h+=j.getClose()}var k=h/this.moveCount,l=g.getFixing().getTime();l>=b&&c>=l&&(d[d.length]=new JenScript.Point2D(g.getFixing().getTime(),k))}this.points=d}}),JenScript.StockMovingAverageLayer=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.StockMovingAverageLayer,JenScript.StockCurveLayer),JenScript.Model.addMethods(JenScript.StockMovingAverageLayer,{__init:function(a){a=a||{},a.name="StockMovingAverageLayer",JenScript.StockCurveLayer.call(this,a)},getGeomInstance:function(){var a={moveCount:this.moveCount};return new JenScript.StockMovingAverageGeometry(a)}})}(),function(){JenScript.StockWeightedMovingAverageGeometry=function(a){this.___init(a)},JenScript.Model.inheritPrototype(JenScript.StockWeightedMovingAverageGeometry,JenScript.CurveStockGeometry),JenScript.Model.addMethods(JenScript.StockWeightedMovingAverageGeometry,{___init:function(a){a=a||{},JenScript.CurveStockGeometry.call(this,a)},solveGeometry:function(){var a=this.getLayer().getHost().getProjection(),b=a.minX,c=a.maxX,d=[],e=this.getLayer().getHost().getStocks();e&&e.sort(function(a,b){return a.getFixing().getTime()>b.getFixing().getTime()?1:-1});for(var f=this.moveCount;f<e.length;f++){for(var g=e[f],h=0,i=0,j=0;j<this.moveCount;j++){var k=e[f-j];h+=(this.moveCount-j)*k.getClose(),i+=this.moveCount-j}var l=h/i,m=g.getFixing().getTime();m>=b&&c>=m&&(d[d.length]=new JenScript.Point2D(g.getFixing().getTime(),l))}this.points=d}}),JenScript.StockWeightedMovingAverageLayer=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.StockWeightedMovingAverageLayer,JenScript.StockCurveLayer),JenScript.Model.addMethods(JenScript.StockWeightedMovingAverageLayer,{__init:function(a){a=a||{},a.name="StockWeightedMovingAverageLayer",JenScript.StockCurveLayer.call(this,a)},getGeomInstance:function(){var a={moveCount:this.moveCount};return new JenScript.StockWeightedMovingAverageGeometry(a)}})}(),function(){JenScript.StockExponentialMovingAverageGeometry=function(a){this.___init(a)},JenScript.Model.inheritPrototype(JenScript.StockExponentialMovingAverageGeometry,JenScript.CurveStockGeometry),JenScript.Model.addMethods(JenScript.StockExponentialMovingAverageGeometry,{___init:function(a){a=a||{},JenScript.CurveStockGeometry.call(this,a)},solveGeometry:function(){var a=this.getLayer().getHost().getProjection(),b=a.minX,c=a.maxX,d=[],e=this.getLayer().getHost().getStocks();e&&e.sort(function(a,b){return a.getFixing().getTime()>b.getFixing().getTime()?1:-1});for(var f=2/(this.moveCount+1),g=this.moveCount;g<e.length;g++){for(var h=e[g],i=h.getClose(),j=1,k=1;k<this.moveCount;k++){var l=e[g-k];i+=Math.pow(1-f,k)*l.getClose(),j+=Math.pow(1-f,k)}var m=i/j,n=h.getFixing().getTime();n>=b&&c>=n&&(d[d.length]=new JenScript.Point2D(h.getFixing().getTime(),m))}this.points=d}}),JenScript.StockExponentialMovingAverageLayer=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.StockExponentialMovingAverageLayer,JenScript.StockCurveLayer),JenScript.Model.addMethods(JenScript.StockExponentialMovingAverageLayer,{__init:function(a){a=a||{},a.name="StockExponentialMovingAverageLayer",JenScript.StockCurveLayer.call(this,a)},getGeomInstance:function(){var a={moveCount:this.moveCount};return new JenScript.StockExponentialMovingAverageGeometry(a)}})}(),function(){JenScript.BollingerStockGeometry=function(a){this.__init(a)},JenScript.Model.inheritPrototype(JenScript.BollingerStockGeometry,JenScript.StockGroupGeometry),JenScript.Model.addMethods(JenScript.BollingerStockGeometry,{__init:function(a){a=a||{},JenScript.StockGroupGeometry.call(this,a),this.moveCount=void 0!==a.moveCount?a.moveCount:20,this.upperPoint=[],this.bottomPoint=[]},setMoveCount:function(a){this.moveCount=a},getMoveCount:function(){return this.moveCount},getCurveUp:function(){return this.upperPoint},getCurveAverage:function(){return this.stockMAs},getCurveBottom:function(){return this.bottomPoint},solveGeometry:function(){var a=this.getLayer().getHost().getProjection(),b=a.minX,c=a.maxX,d=[],e=[],f=[],g=this.getLayer().getHost().getStocks();g&&g.sort(function(a,b){return a.getFixing().getTime()>b.getFixing().getTime()?1:-1});for(var h=this.moveCount;h<g.length;h++){for(var i=g[h],j=i.getFixing().getTime(),k=0,l=0;l<this.moveCount;l++){var m=g[h-l];k+=m.getClose()}var n=k/this.moveCount;j>=b&&c>=j&&(f[f.length]=new JenScript.Point2D(i.getFixing().getTime(),n));for(var o=0,l=0;l<this.moveCount;l++){var m=g[h-l];o+=Math.pow(m.getClose()-n,2)}var p=Math.sqrt(o/this.moveCount);j>=b&&c>=j&&(d[d.length]=new JenScript.Point2D(i.getFixing().getTime(),n+2*p),e[e.length]=new JenScript.Point2D(i.getFixing().getTime(),n-2*p))}this.upperPoint=d,this.bottomPoint=e,this.stockMAs=f}}),JenScript.StockBollingerLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockBollingerLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.StockBollingerLayer,{_init:function(a){a=a||{},this.lineColor=void 0!==a.lineColor?a.lineColor:"black",this.lineOpacity=void 0!==a.lineOpacity?a.lineOpacity:1,this.lineWidth=void 0!==a.lineWidth?a.lineWidth:1,this.bandColor=void 0!==a.bandColor?a.bandColor:"orange",this.bandOpacity=void 0!==a.bandOpacity?a.bandOpacity:.4,this.Id="StockBollinger"+JenScript.sequenceId++,this.bandId=this.Id+"_band",this.upId=this.Id+"_up",this.bottomId=this.Id+"_bottom",JenScript.StockLayer.call(this,{name:"StockBollingerLayer"})},solveLayer:function(){this.clearGeometries();var a=new JenScript.BollingerStockGeometry;a.setLayer(this),a.solveGeometry(),this.addGeometry(a)},paintCurve:function(a,b,c,d,e){for(var f=this.plugin.getProjection(),g=(new JenScript.SVGPath).Id(e),h=0;h<d.length;h++){var i=d[h];0==h?g.moveTo(f.userToPixelX(i.x),f.userToPixelY(i.y)):g.lineTo(f.userToPixelX(i.x),f.userToPixelY(i.y))}var j=g.stroke(this.lineColor).strokeWidth(this.lineWidth).strokeOpacity(this.lineOpacity).fillNone().toSVG();a.child(j)},paintBand:function(a,b,c,d,e){for(var f=this.plugin.getProjection(),g=(new JenScript.SVGPath).Id(this.bandId),h=0;h<d.length;h++){var i=d[h];0==h?g.moveTo(f.userToPixelX(i.x),f.userToPixelY(i.y)):g.lineTo(f.userToPixelX(i.x),f.userToPixelY(i.y))}for(var h=e.length-1;h>=0;h--){var i=e[h];g.lineTo(f.userToPixelX(i.x),f.userToPixelY(i.y))}d.length>0&&e.length>0&&g.close();var j=g.strokeNone().fill(this.bandColor).fillOpacity(this.bandOpacity).toSVG();a.child(j)},paintLayer:function(a,b){if("Device"===b)for(var c=0;c<this.getGeometries().length;c++){var d=(new JenScript.SVGGroup).Id(this.Id).name("StockBollingerLayer"),e=this.getGeometries()[c];this.paintBand(d,a,b,e.getCurveUp(),e.getCurveBottom()),this.paintCurve(d,a,b,e.getCurveBottom(),this.bottomId),this.paintCurve(d,a,b,e.getCurveUp(),this.upId),a.deleteGraphicsElement(this.Id),a.insertSVG(d.toSVG())}}})}(),function(){JenScript.StockMACDGeometry=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockMACDGeometry,JenScript.StockGeometry),JenScript.Model.addMethods(JenScript.StockMACDGeometry,{_init:function(a){a=a||{},this.moveCountMin=void 0!==a.moveCountMin?a.moveCountMin:12,this.moveCountMax=void 0!==a.moveCountMax?a.moveCountMax:26,this.moveCountSignal=void 0!==a.moveCountSignal?a.moveCountSignal:9,JenScript.StockGeometry.call(this,a),this.fixingMap=[]},getFixing:function(a){for(var b=0;b<this.fixingMap.length;b++){var c=this.fixingMap[b];if(a.getFixing().getTime()===c.stock.getFixing().getTime())return c}var d={stock:a};return this.fixingMap[this.fixingMap.length]=d,d},_solveGeometry:function(a,b,c){for(var d=2/(b+1),e=b;e<c.length;e++){for(var f=c[e],g=f.getClose(),h=1,i=1;b>i;i++){var j=c[e-i];g+=Math.pow(1-d,i)*j.getClose(),h+=Math.pow(1-d,i)}var k=g/h;"min"===a&&(this.getFixing(f).min=k),"max"===a&&(this.getFixing(f).max=k)}},_solveSignal:function(a,b){for(var c=2/(a+1),d=a;d<b.length;d++){for(var e=b[d],f=this.getFixing(e),g=f.macd,h=1,i=1;a>i;i++){var j=b[d-i],k=this.getFixing(j);g+=Math.pow(1-c,i)*k.macd,h+=Math.pow(1-c,i)}var l=g/h;f.signal=l}},solveGeometry:function(){var a=this.getLayer().getHost().getStocks();this._solveGeometry("min",this.moveCountMin,a),this._solveGeometry("max",this.moveCountMax,a);for(var b=this.getLayer().getHost().getProjection(),c=(b.minX,b.maxX,0);c<a.length;c++){var d=a[c],e=this.getFixing(d);if(void 0!==e.min&&void 0!==e.max){var f=e.min-e.max;e.macd=f}}this._solveSignal(this.moveCountSignal,a)},getMACD:function(){for(var a=[],b=this.getLayer().getHost().getProjection(),c=b.minX,d=b.maxX,e=this.getLayer().getHost().getStocks(),f=0;f<e.length;f++){var g=e[f],h=g.getFixing().getTime(),i=this.getFixing(g);h>=c&&d>=h&&(a[a.length]=new JenScript.Point2D(g.getFixing().getTime(),i.macd))}return a},getSignal:function(){for(var a=[],b=this.getLayer().getHost().getProjection(),c=b.minX,d=b.maxX,e=this.getLayer().getHost().getStocks(),f=0;f<e.length;f++){var g=e[f],h=g.getFixing().getTime(),i=this.getFixing(g);h>=c&&d>=h&&(a[a.length]=new JenScript.Point2D(g.getFixing().getTime(),i.signal))}return a}}),JenScript.StockMACDLayer=function(a){this._init(a)},JenScript.Model.inheritPrototype(JenScript.StockMACDLayer,JenScript.StockLayer),JenScript.Model.addMethods(JenScript.StockMACDLayer,{_init:function(a){a=a||{},this.macdId="macdlayer"+JenScript.sequenceId++,this.signalId="signallayer"+JenScript.sequenceId++,this.lineColor=void 0!==a.lineColor?a.lineColor:"black",this.lineOpacity=void 0!==a.lineOpacity?a.lineOpacity:1,this.lineWidth=void 0!==a.lineWidth?a.lineWidth:1,this.signalColor=void 0!==a.signalColor?a.signalColor:"red",this.signalOpacity=void 0!==a.signalOpacity?a.signalOpacity:1,this.signalWidth=void 0!==a.signalWidth?a.signalWidth:1,this.macdColor=void 0!==a.macdColor?a.macdColor:"blue",this.macdOpacity=void 0!==a.macdOpacity?a.macdOpacity:1,this.macdWidth=void 0!==a.macdWidth?a.macdWidth:1,this.moveCountSignal=void 0!==a.moveCountSignal?a.moveCountSignal:9,this.moveCountMin=void 0!==a.moveCountMin?a.moveCountMin:12,this.moveCountMax=void 0!==a.moveCountMax?a.moveCountMax:26,a.name="StockMACDLayer",JenScript.StockLayer.call(this,a)},solveLayer:function(){this.clearGeometries();var a={moveCountSignal:this.moveCountSignal,moveCountMin:this.moveCountMin,moveCountMax:this.moveCountMax},b=new JenScript.StockMACDGeometry(a);b.setLayer(this),b.solveGeometry(),this.addGeometry(b)},paintCurve:function(a,b,c,d,e,f,g,h){for(var i=this.plugin.getProjection(),j=(new JenScript.SVGPath).Id(e),k=0;k<d.length;k++){var l=d[k];0==k?j.moveTo(i.userToPixelX(l.x),i.userToPixelY(l.y)):j.lineTo(i.userToPixelX(l.x),i.userToPixelY(l.y))}a.child(j.stroke(f).strokeWidth(g).strokeOpacity(h).fillNone().toSVG())},paintLayer:function(a,b){if("Device"===b)for(var c=0;c<this.getGeometries().length;c++){var d=(new JenScript.SVGGroup).Id(this.Id).name("StockMACDLayer"),e=this.getGeometries()[c],f=e.getMACD(),g=e.getSignal();this.paintCurve(d,a,b,f,this.macdId,this.macdColor,this.macdWidth,this.macdOpacity),this.paintCurve(d,a,b,g,this.signalId,this.signalColor,this.signalWidth,this.signalOpacity),a.deleteGraphicsElement(this.Id),a.insertSVG(d.toSVG())}}})}();